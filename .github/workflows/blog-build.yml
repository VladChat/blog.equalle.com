# ============================================================
# File: .github/workflows/blog-build.yml
# Full path: /.github/workflows/blog-build.yml
# Purpose: Build Hugo site from blog_src â†’ docs, commit docs back to repo,
# and print detailed logs after EVERY step.
# NOTE: Paths trigger only on blog_src/** changes to avoid loops when we
# commit docs/** from CI.
# ============================================================

name: Build Blog

on:
  push:
    branches: [ main ]
    paths:
      - 'blog_src/**'
      - '.github/workflows/blog-build.yml'
  workflow_dispatch:
  workflow_run:
    workflows: ["Blog Writer"]
    types:
      - completed

permissions:
  contents: write

concurrency:
  group: blog-build-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      # 1) Checkout
      - name: â¬‡ï¸ Checkout repository (branch, not SHA)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.ref }}
      - name: ğŸ§¾ Log after checkout
        run: |
          echo "ğŸ—‚  GITHUB_WORKSPACE=$GITHUB_WORKSPACE"
          echo "ğŸ”— Current branch: $(git rev-parse --abbrev-ref HEAD)"
          echo "ğŸ”– Latest commit:  $(git log -1 --pretty='%h %an â€” %s')"
          echo "ğŸ“ Top-level tree:"
          ls -la | sed -n '1,200p'
          echo "ğŸ“ blog_src tree (1 level):"
          find blog_src -maxdepth 2 -type d -print | sed -n '1,200p' || true
          echo "ğŸ“„ blog_src/config.yml exists?"
          test -f blog_src/config.yml && echo "âœ… YES" || (echo "âŒ NO" && exit 1)

      # 2) Hugo tool
      - name: ğŸ›  Set up Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: '0.150.1'
          extended: true
      - name: ğŸ§¾ Log after Hugo setup
        run: |
          hugo version
          echo "----- HUGO ENV -----"
          hugo env || true
          echo "----- CONFIG HEAD -----"
          head -n 40 blog_src/config.yml | sed -n '1,200p'
          echo "----------------------"

      # 3) Pre-create static CNAME/.nojekyll inside blog_src/static (so hugo copies them)
      - name: ğŸ§± Prepare CNAME & .nojekyll in blog_src/static
        run: |
          set -e
          mkdir -p blog_src/static
          echo "blog.equalle.com" > blog_src/static/CNAME
          : > blog_src/static/.nojekyll
          echo "âœ… Prepared:"
          ls -la blog_src/static | sed -n '1,200p'

      # 4) Clean docs/ before build (fresh build)
      - name: ğŸ§¹ Clean docs directory before build
        run: |
          rm -rf docs
          mkdir -p docs
          echo "âœ… docs/ ready (empty):"
          ls -la docs

      # 5) Build
      - name: ğŸ“¦ Build Hugo â†’ docs
        run: |
          set -e
          echo "ğŸ“ Current dir: $(pwd)"
          echo "ğŸš€ Running Hugo build..."
          hugo \
            --config "$GITHUB_WORKSPACE/blog_src/config.yml" \
            --source "$GITHUB_WORKSPACE/blog_src" \
            --destination "$GITHUB_WORKSPACE/docs" \
            --minify --enableGitInfo --noBuildLock
          echo "âœ… Hugo build finished."

      # 6) Post-build verification logs
      - name: ğŸ” Post-build logs & sanity checks
        run: |
          set -e
          echo "==== DOCS ROOT (first 200 entries) ===="
          ls -la docs | sed -n '1,200p'
          echo "==== Ensure critical files exist ===="
          test -f docs/index.html && echo "âœ… docs/index.html OK" || (echo "âŒ docs/index.html missing" && exit 1)
          test -f docs/CNAME && echo "âœ… docs/CNAME OK" || (echo "âŒ docs/CNAME missing (should be copied from static)" && exit 1)
          test -f docs/.nojekyll && echo "âœ… docs/.nojekyll OK" || (echo "âŒ docs/.nojekyll missing (should be copied from static)" && exit 1)
          echo "==== Sitemap quick check ===="
          test -f docs/sitemap.xml && echo "âœ… sitemap.xml present" || (echo "âŒ sitemap.xml missing" && exit 1)
          echo "Newest <lastmod>:"
          grep -oP "(?<=<lastmod>).*?(?=</lastmod>)" docs/sitemap.xml | sort | tail -n 1 || true
          echo "One sample URL from sitemap:"
          grep -oP "(?<=<loc>).*?(?=</loc>)" docs/sitemap.xml | head -n 5
          echo "==== Posts structure (if any) ===="
          if [ -d docs/posts ]; then
            find docs/posts -maxdepth 3 -type d | sed -n '1,200p'
            echo "Sample post index.html (if exists):"
            find docs/posts -name index.html | head -n 1 | xargs -r head -n 10 || true
          else
            echo "âš ï¸ docs/posts directory not found (ok if you have no posts yet)."
          fi

      # 7) Clean up git tree before commit (avoid rebase errors)
      - name: ğŸ§¹ Clean & sync git tree before commit
        run: |
          git add -A
          git commit -m "CI auto-commit" || true
          git pull --rebase --autostash || true

      # 8) Commit docs back to repo so Pages (main:/docs) can serve fresh site
      - name: ğŸ§© Commit built docs back to repo
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Build site to docs [skip ci]"
          file_pattern: docs/**

      # 9) ğŸ” Trigger Cloudflare Pages rebuild via Deploy Hook
      - name: ğŸ” Trigger Cloudflare Pages rebuild
        run: |
          echo "ğŸŒ Triggering Cloudflare rebuild..."
          curl -X POST "https://api.cloudflare.com/client/v4/pages/webhooks/deploy_hooks/16d76f49-835a-46d2-a2ba-d6a6ba9e6ad7"
          echo "âœ… Cloudflare rebuild triggered."

      # 10) Final explicit summary
      - name: ğŸ“£ Summary
        run: |
          echo "âœ… Build completed."
          echo "ğŸ”— Pages is configured to deploy from 'main:/docs'."
          echo "ğŸ“Œ Ensure repo Settings â†’ Pages: Source=Deploy from a branch, Branch=main, Folder=/docs"
          echo "ğŸŒ Custom domain is provided by docs/CNAME â†’ blog.equalle.com"
