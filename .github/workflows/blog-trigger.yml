# ============================================================
# File: .github/workflows/blog-trigger.yml
# Purpose: Randomly trigger the blog-writer workflow 1‚Äì4 times per day
# ============================================================

name: Blog Trigger

on:
  schedule:
    - cron: '0 13 * * *'   # –æ–¥–∏–Ω —Ä–∞–∑ –≤ –¥–µ–Ω—å –≤ 13:00 UTC (~08:00 CST)
  workflow_dispatch:

permissions:
  actions: write
  contents: read

jobs:
  trigger:
    runs-on: ubuntu-latest

    steps:
      - name: Randomly dispatch Blog Writer 1‚Äì4 times
        env:
          GH_TOKEN: ${{ secrets.PAT_GITHUB }}
        run: |
          # ===========================================
          # üîπ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—É—Å–∫–æ–≤ –≤ –¥–µ–Ω—å (1‚Äì4)
          runs=$((1 + RANDOM % 4))
          echo "üìÖ Will trigger the Blog Writer $runs times today."

          # üîπ –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –≤—ã–∑–æ–≤–∞–º–∏ (–≤ –º–∏–Ω—É—Ç–∞—Ö)
          min_delay=45
          max_delay=340

          # ===========================================
          for ((i=1; i<=runs; i++)); do
            if [ $i -gt 1 ]; then
              delay=$((min_delay + RANDOM % (max_delay - min_delay + 1)))
              echo "‚è≥ Waiting $delay minutes before triggering next run..."
              sleep $((delay * 60))
            fi

            echo "üöÄ Dispatching Blog Writer run #$i..."
            curl -X POST \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer $GH_TOKEN" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              https://api.github.com/repos/${{ github.repository }}/actions/workflows/blog-writer.yml/dispatches \
              -d '{"ref": "main"}'

            echo "‚úÖ Triggered run #$i at $(date '+%H:%M:%S')."
            echo "----------------------------------------"
          done

      - name: Done
        run: echo "üéØ All scheduled Blog Writer triggers completed."
