# ============================================================
# File: .github/workflows/blog-writer.yml
# Purpose: Run the blog writer 2‚Äì4 random times per day
# ============================================================

name: Blog Writer

on:
  workflow_dispatch:             # –ø–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
  schedule:
    - cron: '0 13 * * *'         # –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 13:00 UTC (~08:00 –ø–æ CST)
                                 # –º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏, –Ω–æ –æ—Å—Ç–∞–≤–ª—è–µ–º 1 –∑–∞–ø—É—Å–∫ –≤ –¥–µ–Ω—å

permissions:
  contents: write

concurrency:
  group: blog-writer
  cancel-in-progress: true

jobs:
  writer:
    runs-on: ubuntu-latest

    steps:
      # === 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ —Å–∫–∞—á–∏–≤–∞–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π ===
      - name: Checkout repo
        uses: actions/checkout@v4

      # === 2. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Python ===
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      # === 3. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ ===
      - name: Install Python dependencies
        env:
          PIP_DISABLE_PIP_VERSION_CHECK: '1'
          PIP_NO_INPUT: '1'
        run: |
          python -m pip install --upgrade pip
          pip install -r blog_src/scripts/requirements.txt

      # === 4. –ó–∞–ø—É—Å–∫–∞–µ–º writer —Å–ª—É—á–∞–π–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞–∑ —Å –ø–∞—É–∑–∞–º–∏ ===
      - name: Run writer randomly 2‚Äì4 times during the day
        env:
          TZ: America/Chicago   # —á—Ç–æ–±—ã sleep –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–ª—Å—è –ø–æ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–º—É –≤—Ä–µ–º–µ–Ω–∏
        run: |
          # ===========================================
          # üîπ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—É—Å–∫–æ–≤ –≤ –¥–µ–Ω—å (–∏–∑–º–µ–Ω–∏—Ç—å –ø–æ –∂–µ–ª–∞–Ω–∏—é)
          # –ó–¥–µ—Å—å –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è —Å–ª—É—á–∞–π–Ω–æ–µ —á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 4
          runs=$((1 + RANDOM % 4))
          echo "üìÖ Will run the blog writer $runs times today."

          # üîπ –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –∑–∞–ø—É—Å–∫–∞–º–∏ (–≤ –º–∏–Ω—É—Ç–∞—Ö)
          # min_delay ‚Äî –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –æ–∂–∏–¥–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 60 –º–∏–Ω = 1 —á–∞—Å)
          # max_delay ‚Äî –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –æ–∂–∏–¥–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 360 –º–∏–Ω = 6 —á–∞—Å–æ–≤)
          min_delay=45
          max_delay=360

          # ===========================================
          for ((i=1; i<=runs; i++)); do
            if [ $i -gt 1 ]; then
              # –¥–ª—è –≤—Ç–æ—Ä–æ–≥–æ –∏ –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö –∑–∞–ø—É—Å–∫–æ–≤ –¥–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—á–∞–π–Ω—É—é –∑–∞–¥–µ—Ä–∂–∫—É
              delay=$((min_delay + RANDOM % (max_delay - min_delay)))
              echo "‚è≥ Waiting $delay minutes before next run..."
              sleep $((delay * 60))
            fi

            echo "üïí $(date '+%H:%M:%S') ‚Äî starting blog writer run #$i..."
            python blog_src/scripts/main.py || echo "‚ö†Ô∏è Run #$i failed, continuing..."
            echo "‚úÖ Completed run #$i at $(date '+%H:%M:%S')."
            echo "----------------------------------------"
          done

      # === 5. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è ===
      - name: Syntax check
        run: python -m py_compile $(find blog_src/scripts -name '*.py')

      # === 6. –ö–æ–º–º–∏—Ç–∏–º –Ω–æ–≤—ã–µ –ø–æ—Å—Ç—ã, –µ—Å–ª–∏ –æ–Ω–∏ –±—ã–ª–∏ —Å–æ–∑–¥–∞–Ω—ã ===
      - name: Commit and push new posts
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add blog_src/content/posts || true
          git commit -m "ü§ñ Auto-generated new blog posts" || echo "No new posts to commit"
          git push || echo "Nothing to push"
