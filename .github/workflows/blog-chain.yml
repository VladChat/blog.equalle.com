# ============================================================
# File: .github/workflows/blog-chain.yml
# Full path: /.github/workflows/blog-chain.yml
# Purpose: After "Blog Writer" completes successfully, trigger "blog-build.yml"
#          using a Personal Access Token (PAT) to bypass GitHub's workflow->push block.
# ============================================================

name: Blog Chain

on:
  workflow_dispatch:      # —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ (–∫–Ω–æ–ø–∫–∞ Run workflow)
  workflow_run:           # –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –ø–æ—Å–ª–µ Blog Writer
    workflows: ["Blog Writer"]   # –î–û–õ–ñ–ù–û —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å name: –≤ blog-writer.yml
    types: [completed]

permissions:
  actions: write     # –Ω—É–∂–Ω–æ –¥–ª—è –≤—ã–∑–æ–≤–∞ workflow_dispatch —á–µ—Ä–µ–∑ API
  contents: read

jobs:
  trigger_build:
    # –∞–≤—Ç–æ: –∂–¥—ë–º —É—Å–ø–µ—à–Ω—ã–π Blog Writer; —Ä—É—á–Ω–æ–π: —Ä–∞–∑—Ä–µ—à–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å—Ä–∞–∑—É
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest

    steps:
      - name: Check PAT secret presence
        run: |
          if [ -z "${{ secrets.PAT_GITHUB }}" ]; then
            echo "‚ùå Missing PAT_GITHUB secret. Create a Personal Access Token (classic) with 'repo' and 'workflow' scopes and add it as PAT_GITHUB."
            exit 1
          fi
          echo "‚úÖ PAT_GITHUB is present."

      - name: Trigger Blog Build workflow (blog-build.yml)
        env:
          GH_TOKEN: ${{ secrets.PAT_GITHUB }}
        run: |
          echo "üöÄ ${GITHUB_WORKFLOW} is triggering Build Blog..."
          REF_BRANCH="main"

          curl -sS -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/blog-build.yml/dispatches" \
            -d "{\"ref\":\"${REF_BRANCH}\"}" | tee /tmp/dispatch_response.json

          echo "üß™ API response:"
          cat /tmp/dispatch_response.json || true

          if grep -qi '"message":' /tmp/dispatch_response.json; then
            echo "‚ö†Ô∏è GitHub API returned a message (inspect above)."
          fi

      - name: Done
        run: echo "üéØ Blog Chain finished ‚Äî Blog Build dispatched."
