# ============================================================
# File: .github/workflows/blog-chain.yml
# Full path: /.github/workflows/blog-chain.yml
# Purpose: After "Blog Writer" completes successfully, trigger "blog-build.yml"
#          using a Personal Access Token (PAT) to bypass GitHub's workflow->push block.
# ============================================================

name: Blog Chain

on:
  # –°—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è workflow —Å –∏–º–µ–Ω–µ–º "Blog Writer"
  workflow_run:
    workflows: ["Blog Writer"]   # –î–æ–ª–∂–Ω–æ –¢–ï–•–ù–ò–ß–ï–°–ö–ò —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å `name:` –≤–Ω—É—Ç—Ä–∏ blog-writer.yml
    types: [completed]

permissions:
  actions: write     # –Ω—É–∂–Ω–æ –¥–ª—è –≤—ã–∑–æ–≤–∞ workflow_dispatch —á–µ—Ä–µ–∑ API
  contents: read

jobs:
  trigger_build:
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ Blog Writer –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —É—Å–ø–µ—à–Ω–æ
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Check PAT secret presence
        run: |
          if [ -z "${{ secrets.PAT_GITHUB }}" ]; then
            echo "‚ùå Missing PAT_GITHUB secret. Create a Personal Access Token (classic) with 'repo' and 'workflow' scopes and add it as PAT_GITHUB."
            exit 1
          fi
          echo "‚úÖ PAT_GITHUB is present."

      - name: Trigger Blog Build workflow (blog-build.yml)
        env:
          GH_TOKEN: ${{ secrets.PAT_GITHUB }}
        run: |
          echo "üöÄ Blog Writer completed successfully. Triggering Blog Build..."

          # –í–µ—Ç–∫–∞, –∏–∑ –∫–æ—Ç–æ—Ä–æ–π —Å–æ–±–∏—Ä–∞—Ç—å (–∏–∑–º–µ–Ω–∏ –Ω–∞ –Ω—É–∂–Ω—É—é –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)
          REF_BRANCH="main"

          # –í—ã–∑–æ–≤ workflow_dispatch –ø–æ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞ workflow (blog-build.yml)
          curl -sS -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/blog-build.yml/dispatches" \
            -d "{\"ref\":\"${REF_BRANCH}\"}" | tee /tmp/dispatch_response.json

          echo "üß™ API response:"
          cat /tmp/dispatch_response.json || true

          # –ë–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –æ—à–∏–±–æ–∫ –Ω–µ—Ç (–µ—Å–ª–∏ GitHub –≤–µ—Ä–Ω—É–ª –æ–±—ä–µ–∫—Ç —Å message ‚Äî –ø–æ–¥—Å–≤–µ—Ç–∏–º)
          if grep -qi '"message":' /tmp/dispatch_response.json; then
            echo "‚ö†Ô∏è GitHub API returned a message (inspect above)."
          fi

      - name: Done
        run: echo "üéØ Blog Chain finished ‚Äî Blog Build dispatched."
