<!-- File: layouts/partials/head.html -->

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<!-- Google Tag Manager -->
{{ partial "gtm-head.html" . }}
<!-- End Google Tag Manager -->

{{/* =========================================
     Robots: индексируем только в проде и если не задан robotsNoIndex
     ========================================= */}}
{{- $isProd := or hugo.IsProduction (eq site.Params.env "production") -}}
{{- $indexable := and $isProd (ne .Params.robotsNoIndex true) -}}
{{- if $indexable -}}
<meta name="robots" content="index, follow">
{{- else -}}
<meta name="robots" content="noindex, nofollow">
{{- end }}

{{/* =========================================
     TITLE: без обрезки и без бренда в конце для постов/страниц
     Главная — полный бренд (site.Title)
     ========================================= */}}
<title>
  {{- if .IsHome -}}
    {{- site.Title -}}
  {{- else if or .IsSection .IsPage -}}
    {{- .Title | plainify -}}
  {{- else -}}
    {{- site.Title -}}
  {{- end -}}
</title>

{{/* =========================================
     KEYWORDS: оставляем ваш стабильный блок
     ========================================= */}}
{{- $kws := slice -}}
{{- if .IsHome -}}
  {{- if site.Params.keywords -}}
    {{- if (reflect.IsSlice site.Params.keywords) -}}
      {{- $kws = site.Params.keywords -}}
    {{- else -}}
      {{- $kws = (split site.Params.keywords ",") -}}
    {{- end -}}
  {{- end -}}
{{- else -}}
  {{- if .Params.keywords -}}
    {{- if (reflect.IsSlice .Params.keywords) -}}
      {{- $kws = .Params.keywords -}}
    {{- else -}}
      {{- $kws = (split .Params.keywords ",") -}}
    {{- end -}}
  {{- else if .Params.tags -}}
    {{- $kws = .Params.tags -}}
  {{- end -}}
{{- end -}}

{{- $clean := slice -}}
{{- range $kws -}}
  {{- $v := trim . " \t\r\n" -}}
  {{- if $v -}}
    {{- $clean = $clean | append $v -}}
  {{- end -}}
{{- end -}}
{{- $clean = uniq $clean -}}

{{- $normalized := slice -}}
{{- range $clean -}}
  {{- $normalized = $normalized | append (trim . " \t\r\n") -}}
{{- end -}}

{{- if gt (len $normalized) 0 -}}
  <meta name="keywords" content="{{ delimit $normalized ", " | safeHTML }}">
{{- end -}}

{{/* =========================================
     DESCRIPTION: фронт-маттер .Description → .Summary (160)
     (OG/Twitter описания рендерятся отдельными паршалами ниже — не дублируем)
     ========================================= */}}
{{- $descBase := .Description | default (plainify .Summary) -}}
{{- $desc := cond (gt (len $descBase) 180) (truncate 180 $descBase) $descBase -}}
<meta name="description" content="{{ $desc }}">


{{/* Автор — приводим к одной строке */}}
<meta name="author" content="{{ (partial "author.html" . ) | plainify }}">

{{/* Каноникал: приоритет фронт-маттер .Params.canonicalURL */}}
<link rel="canonical" href="{{ if .Params.canonicalURL }}{{ trim .Params.canonicalURL " " }}{{ else }}{{ .Permalink }}{{ end }}">

{{/* Верификации поисковиков (если заданы) */}}
{{- if site.Params.analytics.google.SiteVerificationTag }}
<meta name="google-site-verification" content="{{ site.Params.analytics.google.SiteVerificationTag }}">
{{- end }}
{{- if site.Params.analytics.yandex.SiteVerificationTag }}
<meta name="yandex-verification" content="{{ site.Params.analytics.yandex.SiteVerificationTag }}">
{{- end }}
{{- if site.Params.analytics.bing.SiteVerificationTag }}
<meta name="msvalidate.01" content="{{ site.Params.analytics.bing.SiteVerificationTag }}">
{{- end }}
{{- if site.Params.analytics.naver.SiteVerificationTag }}
<meta name="naver-site-verification" content="{{ site.Params.analytics.naver.SiteVerificationTag }}">
{{- end }}

{{/* =========================================
     СТИЛИ (как у вас, с fingerprinting)
     ========================================= */}}
{{- $includes := slice }}
{{- $includes = $includes | append (" " | resources.FromString "assets/css/includes-blank.css")}}

{{- if not (eq site.Params.assets.disableScrollBarStyle true) }}
  {{- $ScrollStyle := (resources.Get "css/includes/scroll-bar.css") }}
  {{- $includes = (append $ScrollStyle $includes) }}
{{- end }}

{{- $includes_all := $includes | resources.Concat "assets/css/includes.css" }}

{{- $theme_vars := (resources.Get "css/core/theme-vars.css") }}
{{- $reset := (resources.Get "css/core/reset.css") }}
{{- $media := (resources.Get "css/core/zmedia.css") }}
{{- $license_css := (resources.Get "css/core/license.css") }}
{{- $common := (resources.Match "css/common/*.css") | resources.Concat "assets/css/common.css" }}

{{- $chroma_styles := (resources.Get "css/includes/chroma-styles.css") }}
{{- $chroma_mod := (resources.Get "css/includes/chroma-mod.css") }}

{{- $core := (slice $theme_vars $reset $common $chroma_styles $chroma_mod $includes_all $media) | resources.Concat "assets/css/core.css" | resources.Minify }}
{{- $extended := (resources.Match "css/extended/*.css") | resources.Concat "assets/css/extended.css" | resources.Minify }}

{{- $stylesheet := (slice $license_css $core $extended) | resources.Concat "assets/css/stylesheet.css"  }}

{{- if not site.Params.assets.disableFingerprinting }}
  {{- $stylesheet := $stylesheet | resources.Fingerprint }}
  <link crossorigin="anonymous" href="{{ $stylesheet.RelPermalink }}" integrity="{{ $stylesheet.Data.Integrity }}" rel="preload stylesheet" as="style">
{{- else }}
  <link crossorigin="anonymous" href="{{ $stylesheet.RelPermalink }}" rel="preload stylesheet" as="style">
{{- end }}

{{/* =========================================
     Поиск (как у вас)
     ========================================= */}}
{{- if (eq .Layout `search`) -}}
  <link crossorigin="anonymous" rel="preload" as="fetch" href="../index.json">
  {{- $fastsearch := resources.Get "js/fastsearch.js" | js.Build (dict "params" (dict "fuseOpts" site.Params.fuseOpts)) | resources.Minify }}
  {{- $fusejs := resources.Get "js/fuse.basic.min.js" }}
  {{- $license_js := resources.Get "js/license.js" }}
  {{- if not site.Params.assets.disableFingerprinting }}
    {{- $search := (slice $fusejs $license_js $fastsearch ) | resources.Concat "assets/js/search.js" | resources.Fingerprint }}
    <script defer crossorigin="anonymous" src="{{ $search.RelPermalink }}" integrity="{{ $search.Data.Integrity }}"></script>
  {{- else }}
    {{- $search := (slice $fusejs $fastsearch ) | resources.Concat "assets/js/search.js" }}
    <script defer crossorigin="anonymous" src="{{ $search.RelPermalink }}"></script>
  {{- end }}
{{- end -}}

{{/* =========================================
     Favicons
     ========================================= */}}
<link rel="icon" href="{{ site.Params.assets.favicon | default "favicon.ico" | absURL }}">
<link rel="icon" type="image/png" sizes="16x16" href="{{ site.Params.assets.favicon16x16 | default "favicon-16x16.png" | absURL }}">
<link rel="icon" type="image/png" sizes="32x32" href="{{ site.Params.assets.favicon32x32 | default "favicon-32x32.png" | absURL }}">
<link rel="apple-touch-icon" href="{{ site.Params.assets.apple_touch_icon | default "apple-touch-icon.png" | absURL }}">
<link rel="mask-icon" href="{{ site.Params.assets.safari_pinned_tab | default "safari-pinned-tab.svg" | absURL }}">
<meta name="theme-color" content="{{ site.Params.assets.theme_color | default "#2e2e33" }}">
<meta name="msapplication-TileColor" content="{{ site.Params.assets.msapplication_TileColor | default "#2e2e33" }}">

{{/* =========================================
     RSS/alternate
     ========================================= */}}
{{- range .AlternativeOutputFormats -}}
<link rel="{{ .Rel }}" type="{{ .MediaType.Type | html }}" href="{{ .Permalink | safeURL }}" title="{{ .Name }}">
{{- end -}}
{{- range .AllTranslations -}}
<link rel="alternate" hreflang="{{ .Lang }}" href="{{ .Permalink }}">
{{- end -}}
<link rel="alternate" href="{{ .Permalink }}" hreflang="x-default">

<noscript>
  <style>
    #theme-toggle,
    .top-link { display: none; }
  </style>
  {{- if (and (ne site.Params.defaultTheme "light") (ne site.Params.defaultTheme "dark")) }}
  <style>
    @media (prefers-color-scheme: dark) {
      :root {
        --theme: rgb(29, 30, 32);
        --entry: rgb(46, 46, 51);
        --primary: rgb(218, 218, 219);
        --secondary: rgb(155, 156, 157);
        --tertiary: rgb(65, 66, 68);
        --content: rgb(196, 196, 197);
        --code-block-bg: rgb(46, 46, 51);
        --code-bg: rgb(55, 56, 62);
        --border: rgb(51, 51, 51);
      }
      .list { background: var(--theme); }
      .list:not(.dark)::-webkit-scrollbar-track { background: 0 0; }
      .list:not(.dark)::-webkit-scrollbar-thumb { border-color: var(--theme); }
    }
  </style>
  {{- end }}
</noscript>

{{- partial "extend_head.html" . -}}

{{/* =========================================
     PROD-только блок: аналитика + OG/Twitter/Schema
     ВНИМАНИЕ: здесь НЕ дублируем og:* / twitter:* руками,
     это делает templates/opengraph.html и templates/twitter_cards.html
     ========================================= */}}
{{- if $isProd }}
  {{- partial "google_analytics.html" . }}
  {{- partial "templates/opengraph.html" . }}
  {{- if (and (not .Params.blogPosting) (not .Params.faq)) -}}
  {{- partial "templates/schema_json.html" . }}
  {{- end -}}
{{- end -}}
