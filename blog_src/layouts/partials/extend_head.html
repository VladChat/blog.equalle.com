{{/* ============================================================================
     Custom Head Extensions — safe extended_head.html
     Назначение: централизованная загрузка кастомных partials, CSS/JS бандлов,
     мета/OG, а также шаблонная подстановка homepage.css последним.
     В этом файле важно соблюдать порядок подключения ресурсов (см. блок JS).
============================================================================ */}}


{{/* === [Custom Partials, HTML Helpers] ===
     header-fix.html    — исправления разметки/атрибутов в header
     colors.html        — глобальные цветовые CSS-переменные/оверрайды
     accordion.html     — аккордеон секций (создаёт .accordion-section вокруг H2)
     accordion-faq.html — JSON-LD для FAQ + вспомогательная логика
     icons-progress.html— иконки прогресса/шагов
*/}}
{{ partial "custom/header-fix.html" . }}
{{ partial "custom/colors.html" . }}
{{ partial "custom/accordion.html" . }}
{{ partial "custom/accordion-faq.html" . }}
{{ partial "custom/icons-progress.html" . }}

{{/* === [Standalone CSS/JS] не входящие в бандл === */}}
<link rel="stylesheet" href="{{ "css/section-design.css" | absURL }}">
<script src="{{ "js/section-fadein.js" | absURL }}" defer></script>

{{/* === [Layout Vars] Глобальные размеры контейнеров === */}}
<style>
  :root { --main-width: 1152px; --nav-width: var(--main-width); }
</style>

{{/* === [Post Header Styling] Верхний градиентный хедер поста === */}}
<style>
.post-single > header,
.post-single .post-header {
  background: linear-gradient(135deg, var(--brand-blue), var(--brand-cyan));
  border-radius: calc(var(--radius, 12px) + 2px);
  padding: 1.25rem 1.5rem;
  box-shadow: 0 6px 20px rgba(0,0,0,.25);
  margin: 1rem 0 1.75rem 0;
  color:#fff;
}
.post-single > header .post-title,
.post-single .post-header .post-title { color:#fff; margin:0 0 .4rem 0; line-height:1.25; font-weight:800; }
.post-single > header .post-meta,
.post-single .post-header .post-meta { color:#dbeafe; opacity:.95; font-size:.95rem; }
.post-single > header a,
.post-single .post-header a { color:inherit; text-decoration:none; border-bottom:1px dashed rgba(255,255,255,.35); }
.post-single > header a:hover,
.post-single .post-header a:hover { border-bottom-color: rgba(255,255,255,.9); }
body.dark .post-single > header,
body.dark .post-single .post-header { box-shadow:0 6px 22px rgba(0,0,0,.35); }
</style>

{{/* === [Default OpenGraph/Twitter Images] — dynamic from featuredImage or fallback] === */}}
{{- $og := (printf "%simages/equalle-cover-16x9.webp" .Site.BaseURL) -}}
{{- with .Params.featuredImage -}}
  {{- $og = (. | absURL) -}}
{{- end -}}

<meta property="og:image" content="{{ $og }}">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">
<meta name="twitter:image" content="{{ $og }}">
<meta name="twitter:card" content="summary_large_image">


{{/* ============================================================================
     AUTO-BUNDLE: CSS
     Логика:
     1) Явно добавляем критичные custom CSS по имени (порядок гарантирован)
     2) Добираем остальные из css/custom/*.css (кроме исключений)
     3) В самом конце добавляется типографика (typography-merged.css), если есть
     4) Результат конкатенируем → минифицируем → подписываем (SRI)
     Примечание: homepage.css исключается из бандла и подключается САМОЙ ПОСЛЕДНЕЙ
============================================================================ */}}
{{- $cssParts := slice -}}
{{- with (resources.Get "css/custom/colors.css") -}}           {{- $cssParts = $cssParts | append . -}} {{- end -}}
{{- with (resources.Get "css/custom/icons-progress.css") -}}   {{- $cssParts = $cssParts | append . -}} {{- end -}}
{{- with (resources.Get "css/custom/progress.css") -}}         {{- $cssParts = $cssParts | append . -}} {{- end -}}
{{- with (resources.Get "css/custom/accordion.css") -}}        {{- $cssParts = $cssParts | append . -}} {{- end -}}
{{- with (resources.Get "css/custom/accordion-faq.css") -}}    {{- $cssParts = $cssParts | append . -}} {{- end -}}

{{- range (resources.Match "css/custom/*.css") -}}
  {{- if and
        (ne .Name "colors.css")
        (ne .Name "icons-progress.css")
        (ne .Name "progress.css")
        (ne .Name "accordion.css")
        (ne .Name "accordion-faq.css")
        (ne .Name "badges-responsive-fix.css")
        (ne .Name "homepage.css") -}}  {{/* ← исключаем homepage.css */}}
    {{- $cssParts = $cssParts | append . -}}
  {{- end -}}
{{- end -}}

{{- with (resources.Get "css/custom/badges-responsive-fix.css") -}}
  {{- $cssParts = $cssParts | append . -}}
{{- end -}}

{{- if gt (len $cssParts) 0 -}}
  {{- with (resources.Get "css/custom/typography-merged.css") -}}
    {{- $cssParts = $cssParts | append . -}}
  {{- end -}}
  {{- with ($cssParts | resources.Concat "css/custom-bundle.css" | resources.Minify | resources.Fingerprint) -}}
<link rel="stylesheet" href="{{ .RelPermalink }}" integrity="{{ .Data.Integrity }}" crossorigin="anonymous">
  {{- end -}}
{{- end -}}

{{/* ============================================================================
     AUTO-BUNDLE: JS
     ВАЖНО: Порядок имеет значение.
     1) accordion.js — базовый аккордеон секций (оборачивает H2 → .accordion-section)
     2) accordion-faq.js — строит FAQ на базе контейнера из п.1 и/или парсит <h3>/<h4>
     3) icons-progress.js, progress.js — вспомогательные скрипты прогресса
     4) Прочие custom JS из папки, КРОМЕ уже добавленных по именам
============================================================================ */}}
{{- $jsParts := slice -}}
{{- with (resources.Get "js/custom/accordion.js") -}}      {{- $jsParts = $jsParts | append . -}} {{- end -}}  {{/* ← ДОЛЖЕН идти раньше FAQ! */}}
{{- with (resources.Get "js/custom/accordion-faq.js") -}}  {{- $jsParts = $jsParts | append . -}} {{- end -}}
{{- with (resources.Get "js/custom/icons-progress.js") -}} {{- $jsParts = $jsParts | append . -}} {{- end -}}
{{- with (resources.Get "js/custom/progress.js") -}}       {{- $jsParts = $jsParts | append . -}} {{- end -}}

{{- range (resources.Match "js/custom/*.js") -}}
  {{- if and
        (ne .Name "accordion.js")
        (ne .Name "accordion-faq.js")
        (ne .Name "icons-progress.js")
        (ne .Name "progress.js") -}}
    {{- $jsParts = $jsParts | append . -}}
  {{- end -}}
{{- end -}}

{{- if gt (len $jsParts) 0 -}}
  {{- with ($jsParts | resources.Concat "js/custom-bundle.js" | resources.Minify | resources.Fingerprint) -}}
<script src="{{ .RelPermalink }}" defer integrity="{{ .Data.Integrity }}" crossorigin="anonymous"></script>
  {{- end -}}
{{- end -}}

{{/* ============================================================================
     Breadcrumb JSON-LD (только для страниц .IsPage)
============================================================================ */}}
{{ if .IsPage }}
  {{- $items := slice -}}
  {{- $ancestors := .Ancestors.Reverse -}}
  {{- $position := 1 -}}
  {{- range $ancestors }}
    {{- $items = $items | append (dict "@type" "ListItem" "position" $position "name" .Title "item" .Permalink) -}}
    {{- $position = add $position 1 -}}
  {{- end -}}
  {{- $items = $items | append (dict "@type" "ListItem" "position" $position "name" .Title "item" .Permalink) -}}
  <script type="application/ld+json">{{ dict "@context" "https://schema.org" "@type" "BreadcrumbList" "itemListElement" $items | jsonify | safeJS }}</script>
{{ end }}

{{/* ============================================================================
     homepage.css — ВСЕГДА последним (вне бандла), чтобы переопределения работали.
     Используем ExecuteAsTemplate для подстановки контекста сайта/страницы.
============================================================================ */}}
{{ $style := resources.Get "css/custom/homepage.css" }}
{{ $tmpl  := $style | resources.ExecuteAsTemplate "css/custom/homepage.generated.css" . }}
{{ $home  := $tmpl | resources.Minify | resources.Fingerprint }}
<link rel="stylesheet" href="{{ $home.Permalink }}" integrity="{{ $home.Data.Integrity }}">
